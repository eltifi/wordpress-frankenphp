name: wordpress

services:

    web:
        ports:
            - "80:80"
            - "443:443"
            - "443:443/udp"
        dns:
            - 8.8.8.8
            - 1.1.1.1
        build:
            context: .
            dockerfile: Dockerfile
        image: ghcr.io/eltifi/wordpress-frankenphp:latest
        restart: unless-stopped
        deploy:
            resources:
                limits:
                    cpus: '0.5'
                    memory: 1G
                reservations:
                    cpus: '0.25'
                    memory: 512M
        healthcheck:
            test: [ "CMD", "curl", "-f", "http://localhost/wp-admin/admin-ajax.php" ]
            interval: 30s
            timeout: 10s
            retries: 3
            start_period: 40s
        depends_on:
            mysql:
                condition: service_healthy
            redis:
                condition: service_healthy
        environment:
            TZ: ${TZ:-America/New_York}
            # WordPress authentication keys and salts (empty = randomly generated at runtime)
            WORDPRESS_AUTH_KEY: ${WORDPRESS_AUTH_KEY}
            WORDPRESS_SECURE_AUTH_KEY: ${WORDPRESS_SECURE_AUTH_KEY}
            WORDPRESS_LOGGED_IN_KEY: ${WORDPRESS_LOGGED_IN_KEY}
            WORDPRESS_NONCE_KEY: ${WORDPRESS_NONCE_KEY}
            WORDPRESS_AUTH_SALT: ${WORDPRESS_AUTH_SALT}
            WORDPRESS_SECURE_AUTH_SALT: ${WORDPRESS_SECURE_AUTH_SALT}
            WORDPRESS_LOGGED_IN_SALT: ${WORDPRESS_LOGGED_IN_SALT}
            WORDPRESS_NONCE_SALT: ${WORDPRESS_NONCE_SALT}
            # WordPress additional configuration
            WORDPRESS_TABLE_PREFIX: ${WORDPRESS_TABLE_PREFIX:-wp_}
            WORDPRESS_DEBUG: ${WORDPRESS_DEBUG:-false}
            WORDPRESS_CONFIG_EXTRA: ${WORDPRESS_CONFIG_EXTRA}
            # WordPress optimization & feature configuration
            WORDPRESS_REDIS_HOST: ${WORDPRESS_REDIS_HOST:-redis}
            WORDPRESS_REDIS_PORT: ${WORDPRESS_REDIS_PORT:-6379}
            WORDPRESS_REDIS_DATABASE: ${WORDPRESS_REDIS_DATABASE:-0}
            WORDPRESS_REDIS_TIMEOUT: ${WORDPRESS_REDIS_TIMEOUT:-1}
            WORDPRESS_REDIS_READ_TIMEOUT: ${WORDPRESS_REDIS_READ_TIMEOUT:-1}
            WORDPRESS_REDIS_PASSWORD: ${WORDPRESS_REDIS_PASSWORD}
            WORDPRESS_REDIS_PREFIX: ${WORDPRESS_REDIS_PREFIX}
            WORDPRESS_AUTO_UPDATE_CORE: ${WORDPRESS_AUTO_UPDATE_CORE:-minor}
            WORDPRESS_AUTO_UPDATE_PLUGINS: ${WORDPRESS_AUTO_UPDATE_PLUGINS:-false}
            WORDPRESS_AUTO_UPDATE_THEMES: ${WORDPRESS_AUTO_UPDATE_THEMES:-false}
            WORDPRESS_CONCATENATE_SCRIPTS: ${WORDPRESS_CONCATENATE_SCRIPTS:-false}
            WORDPRESS_COMPRESS_SCRIPTS: ${WORDPRESS_COMPRESS_SCRIPTS:-false}
            WORDPRESS_COMPRESS_CSS: ${WORDPRESS_COMPRESS_CSS:-false}
            WORDPRESS_MEMORY_LIMIT: ${WORDPRESS_MEMORY_LIMIT:-1024M}
            WORDPRESS_MAX_MEMORY_LIMIT: ${WORDPRESS_MAX_MEMORY_LIMIT:-1536M}
            WORDPRESS_DISALLOW_FILE_EDIT: ${WORDPRESS_DISALLOW_FILE_EDIT:-true}
            WORDPRESS_EMPTY_TRASH_DAYS: ${WORDPRESS_EMPTY_TRASH_DAYS:-30}
            WORDPRESS_AUTO_SAVE_INTERVAL: ${WORDPRESS_AUTO_SAVE_INTERVAL:-300}
            # Automated Installation Configuration
            WORDPRESS_URL: ${WORDPRESS_URL:-http://localhost}
            WORDPRESS_TITLE: ${WORDPRESS_TITLE:-My Docker WordPress}
            WORDPRESS_ADMIN_USER: ${WORDPRESS_ADMIN_USER:-admin}
            WORDPRESS_ADMIN_PASSWORD: ${WORDPRESS_ADMIN_PASSWORD:-password}
            WORDPRESS_ADMIN_EMAIL: ${WORDPRESS_ADMIN_EMAIL:-admin@example.com}
            # SMTP Configuration
            WORDPRESS_SMTP_HOST: ${WORDPRESS_SMTP_HOST}
            WORDPRESS_SMTP_PORT: ${WORDPRESS_SMTP_PORT}
            WORDPRESS_SMTP_USER: ${WORDPRESS_SMTP_USER}
            WORDPRESS_SMTP_PASSWORD: ${WORDPRESS_SMTP_PASSWORD}
            WORDPRESS_SMTP_FROM: ${WORDPRESS_SMTP_FROM}
            WORDPRESS_SMTP_FROM_NAME: ${WORDPRESS_SMTP_FROM_NAME}
            # General Settings Configuration
            WORDPRESS_TAGLINE: ${WORDPRESS_TAGLINE}
            WORDPRESS_MEMBERSHIP: ${WORDPRESS_MEMBERSHIP}
            WORDPRESS_DEFAULT_ROLE: ${WORDPRESS_DEFAULT_ROLE}
            WORDPRESS_LANGUAGE: ${WORDPRESS_LANGUAGE}
            WORDPRESS_TIMEZONE: ${WORDPRESS_TIMEZONE}
            WORDPRESS_DATE_FORMAT: ${WORDPRESS_DATE_FORMAT}
            WORDPRESS_TIME_FORMAT: ${WORDPRESS_TIME_FORMAT}
            WORDPRESS_START_OF_WEEK: ${WORDPRESS_START_OF_WEEK}
            # Advanced Configuration
            WORDPRESS_CONTENT_URL: ${WORDPRESS_CONTENT_URL}
            WORDPRESS_CONTENT_DIR: ${WORDPRESS_CONTENT_DIR}
            WORDPRESS_DB_QUERY_TIMEOUT: ${WORDPRESS_DB_QUERY_TIMEOUT:-5}
            WORDPRESS_FORCE_SSL_ADMIN: ${WORDPRESS_FORCE_SSL_ADMIN:-true}
            WORDPRESS_FORCE_SSL_LOGIN: ${WORDPRESS_FORCE_SSL_LOGIN:-true}
            WORDPRESS_CACHE_KEY_SALT: ${WORDPRESS_CACHE_KEY_SALT}
            # Database configuration
            WORDPRESS_DB_HOST: ${WORDPRESS_DB_HOST:-mysql:3306}
            WORDPRESS_DB_NAME: ${WORDPRESS_DB_NAME}
            WORDPRESS_DB_USER: ${WORDPRESS_DB_USER}
            WORDPRESS_DB_PASSWORD: ${WORDPRESS_DB_PASSWORD}
            WORDPRESS_DB_CHARSET: ${WORDPRESS_DB_CHARSET:-utf8mb4}
            WORDPRESS_DB_COLLATE: ${WORDPRESS_DB_COLLATE:-utf8mb4_unicode_ci}
            # S3 Uploads Configuration
            ENABLE_S3_UPLOADS: "${ENABLE_S3_UPLOADS:-false}"
            S3_UPLOADS_BUCKET: "${S3_UPLOADS_BUCKET:-wordpress-uploads}"
            S3_UPLOADS_REGION: "${S3_UPLOADS_REGION:-us-east-1}"
            S3_UPLOADS_KEY: "${S3_UPLOADS_KEY:-${AWS_ACCESS_KEY_ID}}"
            S3_UPLOADS_SECRET: "${S3_UPLOADS_SECRET:-${AWS_SECRET_ACCESS_KEY}}"
            S3_UPLOADS_ENDPOINT: "${S3_UPLOADS_ENDPOINT:-${AWS_ENDPOINT}}"
            S3_UPLOADS_BUCKET_URL: "${S3_UPLOADS_BUCKET_URL:-${AWS_ENDPOINT}/${S3_UPLOADS_BUCKET:-wordpress-uploads}}"
            # FrankenPHP configuration
            FORCE_HTTPS: ${FORCE_HTTPS:-0}
            # Worker mode: dramatically improves performance (~70% faster)
            # Syntax: worker <script.php> [num_workers]
            FRANKENPHP_CONFIG: ${FRANKENPHP_CONFIG:-}
            # Number of PHP threads (default: 2x CPU cores)
            FRANKENPHP_NUM_THREADS: ${FRANKENPHP_NUM_THREADS:-}
            # Maximum PHP threads at runtime (can scale up if needed)
            FRANKENPHP_MAX_THREADS: ${FRANKENPHP_MAX_THREADS:-auto}
            # Restart worker after N requests to prevent memory leaks
            MAX_REQUESTS: ${MAX_REQUESTS:-100000}
            # Caddy configuration
            CADDY_SERVER_OPTIONS: ${CADDY_SERVER_OPTIONS}
            CADDY_SERVER_TLS: ${CADDY_SERVER_TLS:-internal}
            CADDY_SERVER_ROOT: ${CADDY_SERVER_ROOT:-/var/www/html}
            SERVER_NAME: ${SERVER_NAME:-localhost}
            # Debug mode (set to 'debug' to enable)
            DEBUG_MODE: ${DEBUG_MODE:-}
            # Custom PHP Config Path (loading default + custom volume)
            PHP_INI_SCAN_DIR: ":/usr/local/etc/php/conf.d:/data/caddy/php"
        #volumes:
        #    - ./wp-content:/var/www/html/wp-content
        #    - ./wp-config.php:/var/www/html/wp-config.php

    mysql:
        expose:
            - 3306
        image: mariadb:12
        restart: unless-stopped
        healthcheck:
            test: "mariadb-admin ping -h localhost -u root -p$${MYSQL_ROOT_PASSWORD}"
            interval: 10s
            timeout: 5s
            retries: 5
            start_period: 30s
        deploy:
            resources:
                limits:
                    cpus: '1'
                    memory: 2G
                reservations:
                    cpus: '0.5'
                    memory: 1G
        command:
            # Replication Config (Master)
            - --log-bin=mysql-bin
            - --server-id=1
            # Standard Config
            - --character-set-server=utf8mb4
            - --collation-server=utf8mb4_unicode_ci
            # CONNECTION MANAGEMENT
            - --max_connections=200
            - --connect_timeout=10
            - --max_connect_errors=100
            - --interactive_timeout=3600
            - --wait_timeout=3600
            # SECURITY
            - --skip-name-resolve
            - --bind-address=0.0.0.0
            - --symbolic-links=0
            - --local-infile=0
            - --skip-external-locking
            # NETWORK PERFORMANCE
            - --max_allowed_packet=64M
            - --net_buffer_length=16K
            # InnoDB
            - --innodb_buffer_pool_size=512M
            - --innodb_buffer_pool_instances=8
            - --innodb_log_file_size=100M
            - --innodb_flush_method=O_DIRECT
            - --innodb_flush_log_at_trx_commit=2
            - --innodb_file_per_table=1
            - --innodb_autoinc_lock_mode=2
        environment:
            TZ: ${TZ:-America/New_York}
            MYSQL_DATABASE: ${WORDPRESS_DB_NAME}
            MYSQL_USER: ${WORDPRESS_DB_USER}
            MYSQL_PASSWORD: ${WORDPRESS_DB_PASSWORD}
            MYSQL_ROOT_PASSWORD: ${WORDPRESS_DB_PASSWORD}
            MYSQL_ROOT_HOST: ${MYSQL_ROOT_HOST:-localhost}
            MYSQL_INITDB_SKIP_TZINFO: 'yes'
            # Replication User Credentials
            MYSQL_REPLICATION_USER: "replicator"
            MYSQL_REPLICATION_PASSWORD: "${WORDPRESS_DB_PASSWORD}" # Reusing for simplicity or use separate var
        volumes:
            - mysql_data:/var/lib/mysql
            - ./seed:/docker-entrypoint-initdb.d
            - ./mysql-init:/docker-entrypoint-initdb.d

    mysql-replica:
        image: mariadb:12
        restart: unless-stopped
        command:
            - --server-id=2
            - --read-only=1
            - --log-bin=mysql-bin # Good practice for relays
        environment:
            TZ: ${TZ:-America/New_York}
            MYSQL_ROOT_PASSWORD: ${WORDPRESS_DB_PASSWORD}
            # Replication Credentials to connect to Master
            MYSQL_REPLICATION_USER: "replicator"
            MYSQL_REPLICATION_PASSWORD: "${WORDPRESS_DB_PASSWORD}"
        volumes:
            - mysql_replica_data:/var/lib/mysql
            # Init script for cloning
            - ./scripts/init-replica.sh:/docker-entrypoint-initdb.d/init-replica.sh
        depends_on:
            mysql:
                condition: service_healthy
        healthcheck:
            test: "mariadb-admin ping -h localhost -u root -p$${MYSQL_ROOT_PASSWORD}"
            interval: 10s
            timeout: 5s
            retries: 5

    redis:
        image: redis:alpine
        command: redis-server --appendonly yes --appendfsync everysec --loglevel warning
        restart: unless-stopped
        healthcheck:
            test: [ "CMD", "redis-cli", "ping" ]
            interval: 10s
            timeout: 5s
            retries: 5
            start_period: 20s
        deploy:
            resources:
                limits:
                    cpus: '0.5'
                    memory: 512M
                reservations:
                    cpus: '0.25'
                    memory: 256M
        environment:
            TZ: ${TZ:-America/New_York}
        volumes:
            - redis_data:/data

    imgproxy:
        image: darthsim/imgproxy:latest
        restart: unless-stopped
        environment:
            # Security: Allow internal network and loopback access only
            IMGPROXY_ALLOWED_SOURCES: "http://web,local://"
            # Optimization: Force WebP output
            IMGPROXY_ENFORCE_WEBP: "true"
            # Optimization: Detect WebP support (though we enforce it, this is good practice)
            IMGPROXY_ENABLE_WEBP_DETECTION: "true"
            # Security: Limit memory usage and image size to prevent DoS
            IMGPROXY_MAX_SRC_RESOLUTION: "30.0"
            IMGPROXY_MEMORY: "512"
            IMGPROXY_CONCURRENCY: "2"
        deploy:
            resources:
                limits:
                    cpus: '0.5'
                    memory: 512M
                reservations:
                    cpus: '0.25'
                    memory: 256M

    backups:
        build:
            context: .
            dockerfile: Dockerfile-backup
        restart: unless-stopped
        environment:
            # Backup Configuration
            BACKUP_CRON_EXPRESSION: "${BACKUP_CRON_EXPRESSION:-0 */12 * * *}"
            BACKUP_RETENTION_DAYS: "${BACKUP_RETENTION_DAYS:-7}"
            BACKUP_FILENAME: "wordpress-full-backup-%Y-%m-%dT%H-%M-%S.tar.gz"
            # S3 / Minio Credentials
            AWS_ACCESS_KEY_ID: "${AWS_ACCESS_KEY_ID}"
            AWS_SECRET_ACCESS_KEY: "${AWS_SECRET_ACCESS_KEY}"
            AWS_S3_BUCKET_NAME: "${AWS_S3_BUCKET_NAME}"
            AWS_ENDPOINT: "${AWS_ENDPOINT}"
            AWS_S3_FORCE_PATH_STYLE: "${AWS_S3_FORCE_PATH_STYLE:-true}"
            AWS_S3_DISABLE_SSL: "${AWS_S3_DISABLE_SSL:-true}"
            AWS_S3_INSECURE: "${AWS_S3_INSECURE:-true}"
            AWS_ENDPOINT_PROTO: "${AWS_ENDPOINT_PROTO:-http}"
            # Database Connection for Dump (TARGET REPLICA)
            WORDPRESS_DB_HOST_NAME: "mysql-replica"
            WORDPRESS_DB_USER: "root" # Use root to ensure full dump permissions
            WORDPRESS_DB_PASSWORD: "${WORDPRESS_DB_PASSWORD}"
            WORDPRESS_DB_NAME: "${WORDPRESS_DB_NAME}"
        volumes:
            # Mount script and source directories
            - ./scripts/backup-db.sh:/etc/dockervolumebackup/prerun/backup-db.sh:ro
            - ./wp-content:/backup/source/wp-content:ro
            # We dump the DB here (inside the container before archiving)
            # The offen image backs up everything in /backup/source
        depends_on:
            mysql:
                condition: service_healthy
            mysql-replica: # Wait for replica
                 condition: service_healthy
            minio:
                 condition: service_healthy

    minio:
        image: minio/minio:latest
        command: server /data --console-address ":9001"
        ports:
            - "59000:9000"
            - "59001:9001"
        environment:
            MINIO_ROOT_USER: "${AWS_ACCESS_KEY_ID:-minioadmin}"
            MINIO_ROOT_PASSWORD: "${AWS_SECRET_ACCESS_KEY:-minioadmin}"
        volumes:
            - ./storage:/data
        healthcheck:
            test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
            interval: 30s
            timeout: 20s
            retries: 3

    miniomc:
        image: minio/mc
        depends_on:
            minio:
                condition: service_healthy
        entrypoint: >
            /bin/sh -c "
            /usr/bin/mc alias set myminio http://minio:9000 ${AWS_ACCESS_KEY_ID:-minioadmin} ${AWS_SECRET_ACCESS_KEY:-minioadmin};
            /usr/bin/mc mb myminio/${AWS_S3_BUCKET_NAME:-wordpress-backups};
            /usr/bin/mc mb myminio/wordpress-uploads;
            /usr/bin/mc anonymous set public myminio/${AWS_S3_BUCKET_NAME:-wordpress-backups};
            /usr/bin/mc anonymous set public myminio/wordpress-uploads;
            exit 0;
            "

volumes:
    mysql_data:
    redis_data:
    mysql_replica_data:

